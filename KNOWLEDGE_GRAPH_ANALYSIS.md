# Knowledge Graph Analysis Report

## Summary

Successfully built Cyber Knowledge Graph from AUVAP pipeline outputs:
- **Experiment Report**: `results/experiment_report_20251111_023313.json`
- **Exploits Manifest**: `exploits/exploits_20251111_023313/exploits_manifest.json`
- **Output**: `knowledge_graphs/kg_20251111_023313.json`

## Graph Statistics

| Metric | Count |
|--------|-------|
| **Hosts** | 5 |
| **Vulnerabilities** | 8 |
| **Capabilities** | 35 |
| **Total Nodes** | 49 |
| **Total Edges** | 44 |

### Relationship Distribution

| Relationship Type | Count | Description |
|------------------|-------|-------------|
| `CONNECTS_TO` | 20 | Network connectivity (all hosts in same /24 subnet) |
| `GRANTS` | 12 | Vulnerability → Capability mappings |
| `VULNERABLE_TO` | 8 | Host → Vulnerability associations |
| `ENABLES` | 3 | Soft dependencies (boosts success probability) |
| `REQUIRES` | 1 | Hard dependencies (must be satisfied first) |

### Exploit Coverage

- **7 out of 8 vulnerabilities** have LLM-generated exploit scripts
- **1 vulnerability** (NO_CVE@10.0.1.13:445) lacks a script

---

## Network Topology

All 5 hosts are in the **10.0.1.0/24** subnet and fully connected:

```
10.0.1.5  ←→  10.0.1.7  ←→  10.0.1.9  ←→  10.0.1.11  ←→  10.0.1.13
   ↑____________↑____________↑_____________↑_____________↑
              (Full mesh - all hosts connected)
```

All hosts marked as **accessible** (initial network access assumed).

---

## Attack Surface Analysis

### Host: 10.0.1.5 (Apache Tomcat / HTTP Server)
**Services**: AJP (8009), HTTP (80), HTTPS (443)

| CVE | CVSS | Service | Auth Required | Granted Capabilities | Script |
|-----|------|---------|---------------|----------------------|--------|
| **CVE-2020-1938** (Ghostcat) | 9.8 | ajp13 | ❌ | ROOT_SHELL (85%), LATERAL_MOVEMENT (90%) | ✅ Python |
| **CVE-2021-41773** (Path Traversal) | 7.5 | http | ❌ | DATA_ACCESS (85%) | ✅ Python |
| **CVE-2021-3711** (OpenSSL) | 8.1 | https | ❌ | CREDENTIALS (85%) | ✅ Python |

**Attack Strategy**:
1. **Primary**: Exploit CVE-2020-1938 (Ghostcat) → Gain root shell + lateral movement
2. **Secondary**: CVE-2021-41773 ENABLES CVE-2020-1938 (boosts success probability)
3. **Secondary**: CVE-2021-3711 ENABLES CVE-2020-1938 (boosts success probability)

---

### Host: 10.0.1.7 (Windows SMB / IIS Server)
**Services**: SMB (445), HTTP (80)

| CVE | CVSS | Service | Auth Required | Granted Capabilities | Script |
|-----|------|---------|---------------|----------------------|--------|
| **CVE-2017-0144** (EternalBlue) | 8.1 | smb | ❌ | ROOT_SHELL (85%), LATERAL_MOVEMENT (90%) | ✅ PowerShell |
| **CVE-2017-7269** (IIS WebDAV) | 7.5 | http | ✅ | USER_SHELL (85%) | ✅ PowerShell |

**Attack Strategy**:
1. **Primary**: Exploit CVE-2017-0144 (EternalBlue) → Gain root shell + lateral movement
2. **Conditional**: CVE-2017-7269 **REQUIRES** credentials → Must exploit other hosts first
3. **Dependency Chain**: CVE-2017-7269 ENABLES CVE-2017-0144 (if credentials available)

---

### Host: 10.0.1.9 (HTTPS Server)
**Services**: HTTPS (443)

| CVE | CVSS | Service | Auth Required | Granted Capabilities | Script |
|-----|------|---------|---------------|----------------------|--------|
| **CVE-2021-3711** (OpenSSL) | 8.1 | https | ❌ | CREDENTIALS (85%) | ✅ Python |

**Attack Strategy**:
- Exploit CVE-2021-3711 → Extract credentials for authenticated exploits on other hosts

---

### Host: 10.0.1.11 (HTTP Server / CGI)
**Services**: HTTP (80)

| CVE | CVSS | Service | Auth Required | Granted Capabilities | Script |
|-----|------|---------|---------------|----------------------|--------|
| **CVE-2014-6271** (Shellshock) | 9.8 | http | ❌ | ROOT_SHELL (85%), LATERAL_MOVEMENT (90%) | ✅ Bash |

**Attack Strategy**:
- Direct exploit CVE-2014-6271 (Shellshock) → Immediate root shell + lateral movement

---

### Host: 10.0.1.13 (Windows SMB Server)
**Services**: SMB (445)

| CVE | CVSS | Service | Auth Required | Granted Capabilities | Script |
|-----|------|---------|---------------|----------------------|--------|
| NO_CVE (SMBv1 Enabled) | 6.5 | smb | ✅ | ROOT_SHELL (85%), LATERAL_MOVEMENT (90%) | ❌ **MISSING** |

**Attack Strategy**:
- **BLOCKED**: No exploit script generated by LLM
- **REQUIRES**: Credentials from other hosts (authenticated access only)

---

## Exploit Dependencies & Attack Chains

### Critical Insight: CVE-2017-7269 (IIS WebDAV) Dependency

```
CVE-2017-7269@10.0.1.7:80 → REQUIRES → credentials@10.0.1.7
```

**This exploit REQUIRES credentials**. Possible credential sources:
1. CVE-2021-3711@10.0.1.5:443 → GRANTS credentials@10.0.1.5 (85%)
2. CVE-2021-3711@10.0.1.9:443 → GRANTS credentials@10.0.1.9 (85%)

### Soft Dependencies (ENABLES Relationships)

Lower-CVSS exploits **ENABLE** higher-CVSS exploits (boost success probability):

```
CVE-2021-41773@10.0.1.5:80  → ENABLES → CVE-2020-1938@10.0.1.5:8009
CVE-2021-3711@10.0.1.5:443  → ENABLES → CVE-2020-1938@10.0.1.5:8009
CVE-2017-7269@10.0.1.7:80   → ENABLES → CVE-2017-0144@10.0.1.7:445
```

**Interpretation**: Exploiting secondary vulnerabilities first increases the probability of successfully exploiting primary critical vulnerabilities.

---

## Optimal Attack Sequence

Based on graph analysis, here's the **optimal exploit order**:

### Phase 1: Independent High-Value Targets (No Dependencies)
1. **CVE-2020-1938@10.0.1.5:8009** (CVSS 9.8) → ROOT_SHELL + LATERAL_MOVEMENT
2. **CVE-2014-6271@10.0.1.11:80** (CVSS 9.8) → ROOT_SHELL + LATERAL_MOVEMENT
3. **CVE-2017-0144@10.0.1.7:445** (CVSS 8.8) → ROOT_SHELL + LATERAL_MOVEMENT

### Phase 2: Credential Harvesting
4. **CVE-2021-3711@10.0.1.5:443** (CVSS 8.1) → CREDENTIALS
5. **CVE-2021-3711@10.0.1.9:443** (CVSS 8.1) → CREDENTIALS

### Phase 3: Authenticated Exploits (Now Credentials Available)
6. **CVE-2017-7269@10.0.1.7:80** (CVSS 7.5) → USER_SHELL (requires credentials from Phase 2)

### Phase 4: Secondary/Enabling Exploits
7. **CVE-2021-41773@10.0.1.5:80** (CVSS 7.5) → DATA_ACCESS

### Phase 5: Blocked (Missing Script)
8. ❌ **NO_CVE@10.0.1.13:445** (CVSS 6.5) → No script available

---

## Comparison: Random Probability vs Knowledge Graph

### Random Probability Simulation (Current Implementation)

```python
# In train_ppo_priority.py: _simulate_exploit()
success_probability = min(0.9, cvss / 10.0)
if random.random() < success_probability:
    success = True
```

**Problems**:
1. ❌ Ignores dependencies (can't exploit CVE-2017-7269 without credentials)
2. ❌ No network topology awareness (treats all hosts as accessible)
3. ❌ No capability tracking (doesn't know what you've already gained)
4. ❌ Unrealistic success rates (independent random rolls)
5. ❌ No attack chain learning (agent doesn't learn prerequisite sequences)

### Knowledge Graph-Based Simulation (Proposed)

```python
# Proposed implementation
feasibility = kg.can_exploit(
    cve="CVE-2017-7269",
    host="10.0.1.7",
    port=80,
    current_capabilities={"credentials@10.0.1.7": True}
)

if feasibility.feasible:
    success = random.random() < feasibility.success_probability
    if success:
        kg.mark_exploited(cve, host, port)  # Updates graph state
```

**Advantages**:
1. ✅ Enforces hard dependencies (REQUIRES credentials)
2. ✅ Models network topology (CONNECTS_TO checks)
3. ✅ Tracks capabilities (knows what you've achieved)
4. ✅ Realistic probabilities (adjusted by prerequisites)
5. ✅ Learns valid attack chains (agent discovers correct sequences)

---

## Implementation Roadmap

### Step 1: Integrate KG into PPO Environment ✅ (Graph Built)

- [x] Build knowledge graph from AUVAP data
- [ ] Load KG in `PriorityMaskedEnv.__init__()`
- [ ] Replace `_simulate_exploit()` with `_simulate_with_kg()`
- [ ] Update `mark_completed()` to call `kg.mark_exploited()`

### Step 2: Test KG-Based Simulation

```bash
python training/train_ppo_priority.py \
    --use-knowledge-graph \
    --kg-path knowledge_graphs/kg_20251111_023313.json \
    --total-timesteps 100000
```

### Step 3: Compare Training Results

| Metric | Random Probability | KG-Based |
|--------|-------------------|----------|
| Episode Reward | ? | ? |
| Success Rate | ? | ? |
| Valid Attack Chains | ? | ? |
| Transferability to Real Execution | ? | ? |

### Step 4: Real Execution Validation

- Run best PPO policy with `--real-execution` flag
- Verify agent learned valid attack sequences
- Compare success rate: simulation vs real execution

---

## Key Graph Insights

### 1. **Full Network Connectivity**
All hosts in 10.0.1.0/24 subnet → No network segmentation → All hosts reachable from any compromised host.

### 2. **3 Critical Vulnerabilities with Root Shell**
- CVE-2020-1938 (Ghostcat) @ 10.0.1.5
- CVE-2014-6271 (Shellshock) @ 10.0.1.11
- CVE-2017-0144 (EternalBlue) @ 10.0.1.7

All grant **ROOT_SHELL + LATERAL_MOVEMENT** → High-value targets.

### 3. **1 Hard Dependency**
CVE-2017-7269 (IIS WebDAV) **REQUIRES** credentials → Must exploit OpenSSL vulnerabilities first.

### 4. **3 Soft Dependencies (ENABLES)**
Lower-CVSS exploits boost higher-CVSS exploits → Multi-stage attack chains increase success rates.

### 5. **1 Missing Exploit**
NO_CVE@10.0.1.13:445 → LLM didn't generate script → Agent can't complete this task.

---

## Next Steps

1. **Modify `train_ppo_priority.py`** to load and use the knowledge graph
2. **Implement KG-based feasibility checking** in `_simulate_exploit()`
3. **Train new PPO model** with KG-based simulation (100K timesteps)
4. **Compare metrics**: Random probability vs KG-based approach
5. **Validate with real execution**: Does KG-trained agent perform better?

---

## Files Generated

- **Knowledge Graph**: `knowledge_graphs/kg_20251111_023313.json`
- **Analysis Report**: `KNOWLEDGE_GRAPH_ANALYSIS.md` (this file)
- **Builder Script**: `build_knowledge_graph.py`

## Command to Rebuild

```bash
python build_knowledge_graph.py \
    --experiment-report results/experiment_report_20251111_023313.json \
    --exploits-manifest exploits/exploits_20251111_023313/exploits_manifest.json \
    --output knowledge_graphs/kg_20251111_023313.json
```

---

**Report Generated**: 2024-11-11  
**AUVAP Pipeline Run**: 2025-11-11 02:33:13  
**Total Vulnerabilities**: 8  
**Exploitable Vulnerabilities**: 7 (87.5%)
